<div class="search clearfix extsearch">
  <form name="search" action="index.php?id={pidOfSearchPage}&no_cache=1&tx_schooldirectory_list[action]=search&tx_schooldirectory_list[controller]=School" method="post">
    <dl id="schoolType">
      <dt><f:translate key="tx_schooldirectory_domain_model_type"/></dt>
      <dd><select name="tx_schooldirectory_list[type]"></select></dd>
    </dl>
    <dl id="schoolCareForm">
      <dt><f:translate key="tx_schooldirectory_domain_model_school.care_forms"/></dt>
      <dd><select name="tx_schooldirectory_list[careForm]"></select></dd>
    </dl>
    <dl id="schoolProfile">
      <dt><f:translate key="tx_schooldirectory_domain_model_school.profile_title"/></dt>
      <dd><select name="tx_schooldirectory_list[profile]"></select></dd>
    </dl>
    <div class="submitwrap">
      <f:form.submit value="{f:translate(key: 'search')}"/>
    </div>
  </form>
</div>

<script type="text/javascript">
  jQuery(function() {

    var schoolType = "{type}";
    var schoolCareForm = "{careForm}";
    var schoolProfile = "{profile}";

    // hide both selectboxes at loading
    jQuery( "#schoolType").hide();
    jQuery( "#schoolCareForm").hide();
    jQuery( "#schoolProfile").hide();

    showType();
    if (schoolCareForm) showCareForm(schoolType);
    if (schoolProfile) showProfile(schoolType, schoolCareForm);

    // show care form after selecting an type
    jQuery( "#schoolType select").on( "change", function() {
      jQuery( "#schoolCareForm").hide();
      jQuery( "#schoolProfile").hide();
      showCareForm(jQuery( this ).val());
    });

    // show profile after selecting an care form
    jQuery( "#schoolCareForm select").on( "change", function() {
      jQuery( "#schoolProfile").hide();
      showProfile(jQuery( "#schoolType select").val(), jQuery( this ).val());
    });

    /**
     * show type
     *
     * @return void
     */
    function showType() {
      var ajaxUri = "{f:widget.uri(action: 'renderType', ajax: 1)}";
      <![CDATA[
      jQuery.ajax({
        type: "POST",
        url: ajaxUri,
        cache: false,
        dataType: "json"
      }).success(
        function(data) {
          if (!data.error) {
            // add empty option
            $option = jQuery( "<option />" ).attr( "value", "").html( "" );
            jQuery( "#schoolType select").append( $option );

            // add options from ajax request
            jQuery.each(data.types, function(index, value) {
              $option = jQuery( "<option />" ).attr( "value", value.uid).html( value.title );
              if (schoolType == value.uid) {
                $option.attr( "selected", "selected" );
              }
              jQuery( "#schoolType select").append( $option );
            });
            jQuery( "#schoolType").show();
          }
        }
      ).error(function() {
        console.log( "error" );
      });
      ]]>
    }

    /**
     * show care form
     *
     * @param integer schoolType
     * @return void
     */
    function showCareForm(schoolType) {
      var ajaxUri = "{f:widget.uri(action: 'renderCareForm', ajax: 1)}";
      <![CDATA[
      jQuery.ajax({
        type: "POST",
        url: ajaxUri,
        cache: false,
        dataType: "json",
        data: {
          schoolType: schoolType
        }
      }).success(
        function(data) {
          if (!data.error) {
            jQuery( "#schoolCareForm select option").remove();
            jQuery( "#schoolCareForm select").append( jQuery( "<option />" ).attr( "value", '0').html( '' ) );
            jQuery.each(data.careForms, function(index, value) {
              $option = jQuery( "<option />" ).attr( "value", value.uid).html( value.title );
              if (schoolCareForm == value.uid) {
                $option.attr( "selected", "selected" );
              }
              jQuery( "#schoolCareForm select").append( $option );
            });
            jQuery( "#schoolCareForm").show();
          }
        }
      ).error(function() {
        console.log( "error" );
      });
      ]]>
    }

    /**
     * show profile
     *
     * @param integer schoolType
     * @param integer schoolCareForm
     * @return void
     */
    function showProfile(schoolType, schoolCareForm) {
      var ajaxUri = "{f:widget.uri(action: 'renderProfile', ajax: 1)}";
      <![CDATA[
      jQuery.ajax({
        type: "POST",
        url: ajaxUri,
        cache: false,
        dataType: "json",
        data: {
          schoolType: schoolType,
          schoolCareForm: schoolCareForm
        }
      }).success(
        function(data) {
          if (!data.error) {
            jQuery( "#schoolProfile select option").remove();
            jQuery( "#schoolProfile select").append( jQuery( "<option />" ).attr( "value", '0').html( '' ) );
            jQuery.each(data.profiles, function(index, value) {
              $option = jQuery( "<option />" ).attr( "value", value.uid).html( value.title );
              if (schoolProfile == value.uid) {
                $option.attr( "selected", "selected" );
              }
              jQuery( "#schoolProfile select").append( $option );
            });
            jQuery( "#schoolProfile").show();
          }
        }
      ).error(function() {
        console.log( "error" );
      });
      ]]>
    }
  });
</script>
